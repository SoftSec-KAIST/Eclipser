--- qemu-2.10.0-branch/accel/tcg/cpu-exec.c.orig	2020-10-03 21:06:01.813430015 -0700
+++ qemu-2.10.0-branch/accel/tcg/cpu-exec.c	2020-10-03 21:05:57.233402733 -0700
@@ -36,6 +36,12 @@
 #include "sysemu/cpus.h"
 #include "sysemu/replay.h"
 
+#include "afl-qemu-cpu-inl.h"
+extern abi_ulong chatkey_entry_point; /* ELF entry point (_start) */
+extern void chatkey_setup_before_forkserver(void);
+extern void chatkey_setup_after_forkserver(void);
+extern void chatkey_log_bb(abi_ulong addr);
+
 /* -icount align implementation. */
 
 typedef struct SyncClocks {
@@ -143,6 +149,17 @@
     TranslationBlock *last_tb;
     int tb_exit;
     uint8_t *tb_ptr = itb->tc_ptr;
+    abi_ulong entry_pc;
+
+    entry_pc = itb->pc;
+    if(entry_pc == chatkey_entry_point) {
+      chatkey_setup_before_forkserver();
+      // Resolves util/rcu.c assertion error issue (cf. AFL-2.53b).
+      rcu_disable_atfork();
+      afl_forkserver(cpu);
+      chatkey_setup_after_forkserver();
+    }
+    chatkey_log_bb(entry_pc);
 
     qemu_log_mask_and_addr(CPU_LOG_EXEC, itb->pc,
                            "Trace %p [%d: " TARGET_FMT_lx "] %s\n",
@@ -365,6 +382,7 @@
             if (!tb) {
                 /* if no translated code available, then translate it now */
                 tb = tb_gen_code(cpu, pc, cs_base, flags, 0);
+                afl_request_tsl(pc, cs_base, flags);
             }
 
             mmap_unlock();
